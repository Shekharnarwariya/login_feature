package com.hti.smpp.addressbook.impl;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;

import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.DataFormatter;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.hti.smpp.addressbook.request.ContactEntryRequest;
import com.hti.smpp.addressbook.services.ContactEntryService;
import com.hti.smpp.addressbook.utils.Converters;
import com.hti.smpp.common.contacts.dto.ContactEntry;
import com.hti.smpp.common.contacts.repository.ContactRepository;
import com.hti.smpp.common.util.IConstants;

@Service
public class ContactEntryServiceImpl implements ContactEntryService{
	
	private static final Logger logger = LoggerFactory.getLogger(ContactEntryServiceImpl.class.getName());
	
	@Autowired
	private ContactRepository contactRepo;

	@Override
	public ResponseEntity<?> saveContactEntry(ContactEntryRequest form, String username) {
		
		String target = IConstants.FAILURE_KEY;
		try {
			int groupId = form.getGroupId();
			String mode = form.getType();
			String format = null;
			List<ContactEntry> entry_list = new ArrayList<ContactEntry>();
			// -------------------------------------------
			if (mode.equalsIgnoreCase("multiple")) {
				MultipartFile uploadedFile = form.getFile();
				String file_name = uploadedFile.getName();
				if (file_name.indexOf(".xls") > 0) {
					format = "Excel";
				} else if (file_name.indexOf(".txt") > 0) {
					format = "Text";
				}
				if (format != null) {
					if (format.equalsIgnoreCase("Text")) {
						BufferedReader bufferedReader = null;
						try {
							bufferedReader = new BufferedReader(
									new InputStreamReader(form.getFile().getInputStream(), "UTF-8"));
							int x = 0;
							String entry = null;
							while ((entry = bufferedReader.readLine()) != null) {
								x++;
								logger.info(x + ": " + entry);
								if (entry != null && entry.length() > 0) {
									String[] tokens = entry.split(",");
									String name = null, email = null;
									long number;
									if (tokens.length == 0) {
										logger.info("Invalid Format For Entry[" + x + "]: " + entry);
										continue;
									} else {
										try {
											tokens[0] = tokens[0].replaceAll("\\s+", ""); // Replace all the spaces in the String with empty character.
											number = Long.parseLong(tokens[0]);
										} catch (Exception ex) {
											logger.info("Invalid Number For Entry[" + x + "]: " + entry);
											continue;
										}
										if (tokens.length == 2) {
											if (tokens[1].contains("@")) {
												email = tokens[1];
											} else {
												name = tokens[1];
											}
										} else if (tokens.length == 3) {
											name = tokens[1];
											email = tokens[2];
										}
										if (name != null && name.length() > 0) {
											name = new Converters().UTF16(name);
										}
										if (email != null && email.length() > 40) {
											logger.info(x + " Email need to truncate: " + email.length());
											email = email.substring(0, 40);
										}
										entry_list.add(new ContactEntry(name, number, email, groupId));
									}
								}
							}
						} catch (Exception ex) {
							logger.error("Error: "+ex.getLocalizedMessage());
						} finally {
							if (bufferedReader != null) {
								try {
									bufferedReader.close();
								} catch (IOException ioe) {
									bufferedReader = null;
								}
							}
						}
					} else if (format.equalsIgnoreCase("Excel")) {
						Workbook workbook = null;
						try {
							if (file_name.indexOf(".xlsx") > 0) {
								workbook = new XSSFWorkbook(form.getFile().getInputStream());
							} else {
								workbook = new HSSFWorkbook(form.getFile().getInputStream());
							}
							Sheet firstSheet = workbook.getSheetAt(0);
							logger.info("Sheet[0] Total Rows: " + firstSheet.getPhysicalNumberOfRows());
							// int x = 0;
							int column_count = 0;
							for (Row nextRow : firstSheet) {
								// x++;
								if (nextRow.getRowNum() == 0) {
									column_count = nextRow.getPhysicalNumberOfCells();
									if (column_count == 0) {
										logger.info("Invalid Format For Xls File");
										break;
									}
								}
								String name = null, email = null;
								long number = 0;
								String cell_value = null;
								for (int i = 0; i < nextRow.getLastCellNum(); i++) {
									Cell cell = nextRow.getCell(i);
									cell_value = new DataFormatter().formatCellValue(cell);
									if (i == 0) {
										try {
											number = Long.parseLong(cell_value);
										} catch (Exception ex) {
											logger.info("Invalid Number For Entry[" + nextRow.getRowNum() + "]: "
													+ cell_value);
											break;
										}
									}
									if (cell_value != null) {
										if (i == 1) {
											name = cell_value;
										} else if (i == 2) {
											if (cell_value.contains("@")) {
												email = cell_value;
											}
										}
									}
									if (i == 2) {
										break;
									}
								}
								logger.info(nextRow.getRowNum() + ": groupId=" + groupId + ",name=" + name + ",number="
										+ number + ",email=" + email);
								if (number > 0) {
									if (name != null && name.length() > 0) {
										name = new Converters().UTF16(name);
									}
									if (email != null && email.length() > 40) {
										logger.info(nextRow.getRowNum() + " Email need to truncate: " + email.length());
										email = email.substring(0, 40);
									}
									entry_list.add(new ContactEntry(name, number, email, groupId));
								}
							}
						} catch (Exception ex) {
							logger.info("Error: " +ex.getLocalizedMessage());
						} finally {
							if (workbook != null) {
								try {
									workbook.close();
								} catch (Exception e) {
								}
							}
						}
					}
				}
			} else {
				String name = null, email = null;
				if (form.getNumber() != null && form.getNumber()[0] > 0) {
					if (form.getName() != null && form.getName()[0].length() > 0) {
						name = new Converters().UTF16(form.getName()[0]);
					}
					if (form.getEmail() != null && form.getEmail()[0].length() > 0) {
						if (form.getEmail()[0].contains("@")) {
							email = form.getEmail()[0];
						}
					}
					entry_list.add(new ContactEntry(name, form.getNumber()[0], email, groupId));
				} else {
					logger.info("Invalid Number Found: " + form.getNumber());
				}
			}
			if (entry_list.isEmpty()) {
				//message = new ActionMessage("error.processError");
			} else {
				// ContactDAService service = new ContactDAServiceImpl();
				//GlobalVars.contactService.saveContactEntry(entry_list);
				this.contactRepo.saveAll(entry_list);
				target = IConstants.SUCCESS_KEY;
				//message = new ActionMessage("message.operation.success");
				
			}
		} catch (Exception e) {
			logger.error("Error: "+e.getLocalizedMessage());
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
		}
		
		
		return null;
	}
	
	

}
